CREATE DATBASE library_db;

USE library_db;

CREATE TABLE Borrower (
    Rollno INT(4),
    Name VARCHAR(20),
    DateofIssue DATE,
    NameofBook VARCHAR(30),
    Status VARCHAR(10)
);

CREATE TABLE Fine (
    Rollno INT(4),
    Date DATE,
    Amount INT(10)
);

INSERT INTO Borrower VALUES(14, 'Ram', '2025-09-19', 'Operating System', 'I');
INSERT INTO Borrower VALUES(27, 'Soham', '2025-08-24', 'Object Oriented Programming', 'I'); -- More than 30 days ago
INSERT INTO Borrower VALUES(34, 'Mohan', '2025-10-12', 'Microprocessor', 'I'); -- Between 15 and 30 days ago
INSERT INTO Borrower VALUES(48, 'Om', '2025-10-25', 'Mechanics', 'I'); -- Less than 15 days ago

DELIMITER //

CREATE PROCEDURE Calculate_Fine_And_Update (
    IN p_Rollno INT, 
    IN p_NameofBook VARCHAR(30)
)
BEGIN
    -- Declare variables
    DECLARE v_DateofIssue DATE;
    DECLARE v_days_diff INT;
    DECLARE v_fine_amount INT DEFAULT 0;
    DECLARE v_record_found BOOLEAN DEFAULT TRUE;

    -- Declare a handler for NOT FOUND condition
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_record_found = FALSE;

    -- Get the DateofIssue for the given Rollno and NameofBook
    SELECT DateofIssue INTO v_DateofIssue 
    FROM Borrower 
    WHERE Rollno = p_Rollno AND NameofBook = p_NameofBook AND Status = 'I';

    -- Check if the record was found
    IF v_record_found THEN
        -- Calculate the difference in days between today and the issue date
        SET v_days_diff = DATEDIFF(CURDATE(), v_DateofIssue); --

        -- Control Structure: Calculate fine based on days difference
        IF v_days_diff > 30 THEN
            -- Fine is Rs 50/day for days > 30 AND Rs 5/day for the first 30 days
            SET v_fine_amount = ( (v_days_diff - 30) * 50 ) + (30 * 5); -- Logic adapted from 
            INSERT INTO Fine (Rollno, Date, Amount) VALUES (p_Rollno, CURDATE(), v_fine_amount); --
        ELSEIF v_days_diff >= 15 THEN
            -- Fine is Rs 5/day for 15-30 days
            SET v_fine_amount = v_days_diff * 5; -- [cite: 1038, 2284]
            INSERT INTO Fine (Rollno, Date, Amount) VALUES (p_Rollno, CURDATE(), v_fine_amount); --
        END IF;

        -- Update the status in the Borrower table to 'R' (Returned)
        UPDATE Borrower 
        SET Status = 'R' 
        WHERE Rollno = p_Rollno AND NameofBook = p_NameofBook; -- 

        -- Output message (optional)
        IF v_fine_amount > 0 THEN
            SELECT CONCAT('Book returned. Fine calculated: Rs ', v_fine_amount) AS Message;
        ELSE
            SELECT 'Book returned. No fine.' AS Message;
        END IF;

    ELSE
        -- Exception Handling: Output message if record not found
        SELECT 'Error: Borrower record not found or book already returned.' AS ErrorMessage;
    END IF;

END //

DELIMITER ;

CALL Calculate_Fine_And_Update(27, 'Object Oriented Programming'); 
SELECT * FROM Fine WHERE Rollno = 27; -- Check if fine was added
SELECT * FROM Borrower WHERE Rollno = 27; -- Check if status is 'R'

CALL Calculate_Fine_And_Update(34, 'Microprocessor');
SELECT * FROM Fine WHERE Rollno = 34; -- Check if fine was added
SELECT * FROM Borrower WHERE Rollno = 34; -- Check if status is 'R'

CALL Calculate_Fine_And_Update(48, 'Mechanics');
SELECT * FROM Fine WHERE Rollno = 48; -- Should be empty (no fine)
SELECT * FROM Borrower WHERE Rollno = 48; -- Check if status is 'R'

CALL Calculate_Fine_And_Update(99, 'NonExistent Book'); -- Should show the error message

